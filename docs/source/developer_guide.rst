Project Code Overview
=====================

After installing the virtual environment as described in the :ref:`Project
Overview <project_overview>` setup your IDE to use the virtual
environment generated by Poetry. It is commonly found under
``recommender/venv/recommender``.

The project is structured into 14 folders:

- `data <./../data>`__: Contains code regarding the indexing of data sets and reading of stored indices

- `dataset <../datasets>`__: Contains code regarding the integration of data sets into the framework
- `dm <./../dm>`__: Contains code for the use of the dota data set as a pytorch lightning data module
- `docs <./../docs>`__: Contains Markdown files which contain the documentation for this project
- `k8s <./../k8s>`__: Contains a dockerfile which defines a docker container which runs a model when started, an example for a kubernetes job and pod configuration for said dockerfile.
- `logger <./../logger>`__: Contains code for the logging of pytorch training loss and pytorch training metrics
- `losses <../asme/losses>`__: Contains code regarding custom loss functions which can be integrated into pytorch training
- `metrics <../asme/metrics>`__: Contains code reagarding the implementation of recommendation metrics which are integrated using pytorch
- `models <../asme/models>`__: Contains pytorch implementations of the models provided by this framework
- `modules <../asme/modules>`__: Contains pytorch-lightning wrappers for the pytorch models defined in `models <../asme/models>`__
- `projects <../configs>`__: Contains yaml files which are needed to configure the uses of models in conjunction with metrics and data sets.
- `runner <../asme/runner>`__: Also contains Typer-CLI implementation for indexing data sets, but also the Typer-CLI implementation for training a model and performing predictions with it, as well as necessary support-code
- `tests <./../tests>`__: Contains unit tests for the project. Also contains an example data set as well as the respective vocabulary and index file
- `tokenization <../asme/tokenization>`__: Contains code concerning the tokenization of session items and the building of a vocabulary for data sets.

Adding a new Metric
-------------------

The metric needs to be able to handle tensors to be compatible with
pytorch.

To implement it go to
`metrics/ranking\_metrics <../asme/metrics/ranking_metrics.py>`__ and
implement a new metrics class.

Adding a new Data set
---------------------

In order to implement a new dataset, you have to teach ASME how to download, preprocess and index your data. You can do this by defining a preprocessing configuration provider:

.. code-block::

    def get_my_dataset_preprocessing_config(output_dir: Path, ...) -> DatasetPreprocessingConfig:
        ...

This function should return a `DatasetPreprocessingConfig` instance that contains the following data:

- name: The name that will be used to identify files of your dataset.
- url (Optional): Specifies where your dataset should be downloaded from. If this is not set you have to specify the input directory via the context object below by setting the `INPUT_DIR_KEY`.
- location: Path Specifies where the final dataset will reside.
- unpacker (Optinal): An Unpacker instance (e.g. Unzipper) that is used to unpack your dataset.
- preprocessing_actions (Optional): A list of `PreprocessingActions` that should be applied to your dataset.
- context (Optional): The `Context` instance that will be passed between preprocessing actions. You can pre-specify keys such as `DELIMITER_KEY` or `INPUT_DIR_KEY` here.

For an example of how to implement a preprocessing configuration provider, refer to `data/datasets/config.py <../asme/data/dataset/config.py>`__ .

Since you usually want to have default values for many of the parameters to your preprocessing configuration provider, we wrap the function into a `PreprocessingConfigProvider` which can hold default values for any of the parameters of your function.
Additionally, you have to register your provider with ASME such that you can refer to your dataset in configuration files run by ASME. To do so, you have to call `register_preprocessing_config_provider` as follows:

.. code-block::

    register_preprocessing_config_provider(PreprocessingConfigProvider("my_dataset", get_my_dataset_preprocessing_config,
        my_param_1=default_value_1,
        my_param_5=default_value_5,
        ...,
        )
    )

You will then be able to refer to your dataset via the name passed to the function call above (e.g. "my_dataset" in this case).


Adding a new Model
------------------

In order to add a new model multiple things need to be implemented:

1. The model itself as a pytorch model in `models <../asme/models>`__
2. A pytorch lightning module that wraps the torch implementation of your newly implemented model in `modules <../asme/modules>`__
3. A configuration container in `runner/util/containers <../asme/runner/util/containers.py>`__ and the respective connection in `runner/run\_model <../asme/runner/run_model.py>`__

Things that are not Documented
------------------------------

This section lists areas of the project that are not documented/need
code comments:

- Contents of the "support-code" in `runner/util <../asme/runner/util>`__
- Most methods, classes, and modules

Refactor proposals
------------------

-  The predition logger callback for pytorch lightning is contained in
   `runner/util <../asme/runner/util>`__ (I [AL] would expect this to be
   at `logger <./../logger>`__)
-  The code in `runner/util <../asme/runner/util>`__ is quite extensive
   and should probably be moved into multiple separate directories (e.g.
   `runner/util/containers <../asme/runner/util/containers.py>`__ could
   be a directory)
-  Every directory deserves its own little README.md describing its
   purpose, contents, and implementation hints in a few sentences
-  If this project aims to become a CLI one day the project structure
   should represent that by:

   -  Either: directories should be structured into commands
   -  Or: An app directory should be created in which commands are
      defined and registered at one central file

-  If a class is defined in a file the file should have the same name as
   the class (e.g., `indexer.py <./../data/base/indexer.py>`__ defines
   the CsvSessionIndexer class)
-  If a file defines multiple classes make it a directory.
-  Rename `dm <./../dm>`__ to datamodules or remove it

